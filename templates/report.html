<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Inventory Report - Backstock Inventory</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      /* Global Styles */
      body {
        padding-bottom: 80px;
        font-size: 16px;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 1400px;
        padding: 15px;
      }

      /* Header */
      .report-header {
        background: linear-gradient(135deg, #CE2029 0%, #a31920 100%);
        color: white;
        padding: 30px 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }

      .report-header h1 {
        margin: 0 0 10px 0;
        font-size: 2rem;
      }

      .report-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 1.1rem;
      }

      /* Back Button */
      .back-button {
        background-color: white;
        color: #CE2029;
        border: 2px solid white;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 15px;
        text-decoration: none;
        display: inline-block;
      }

      .back-button:hover {
        background-color: rgba(255,255,255,0.9);
        color: #a31920;
        text-decoration: none;
      }

      /* Summary Cards */
      .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .summary-card {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }

      .summary-card.alert-card {
        border-left: 4px solid #f0ad4e;
      }

      .summary-card.danger-card {
        border-left: 4px solid #d9534f;
      }

      .summary-card-title {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .summary-card-value {
        font-size: 2.2rem;
        font-weight: bold;
        color: #CE2029;
        margin: 0;
      }

      .summary-card-subtitle {
        font-size: 0.85rem;
        color: #999;
        margin-top: 5px;
      }

      /* Chart Containers */
      .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }

      .chart-container {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .chart-container.full-width {
        grid-column: 1 / -1;
      }

      .chart-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #CE2029;
      }

      .chart-wrapper {
        position: relative;
        height: 350px;
        margin-top: 20px;
      }

      .chart-wrapper.tall {
        height: 450px;
      }

      /* Reorder Table */
      .reorder-table {
        width: 100%;
        margin-top: 15px;
        border-collapse: collapse;
      }

      .reorder-table th {
        background-color: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
        font-size: 0.9rem;
      }

      .reorder-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #dee2e6;
      }

      .reorder-table tr:hover {
        background-color: #f8f9fa;
      }

      .stock-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .stock-badge.critical {
        background-color: #d9534f;
        color: white;
      }

      .stock-badge.low {
        background-color: #f0ad4e;
        color: white;
      }

      /* Footer */
      .page-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #fff;
        border-top: 1px solid #dee2e6;
        padding: 15px;
        text-align: center;
        font-size: 0.9rem;
        z-index: 1000;
      }

      .page-footer p {
        margin: 0;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 8px;
        margin: 40px 0;
      }

      .empty-state h2 {
        color: #666;
        margin-bottom: 15px;
      }

      .empty-state p {
        color: #999;
        font-size: 1.1rem;
      }

      /* Mobile Optimizations */
      @media (max-width: 768px) {
        .report-header h1 {
          font-size: 1.5rem;
        }

        .report-header p {
          font-size: 0.95rem;
        }

        .summary-cards {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .summary-card-value {
          font-size: 2rem;
        }

        .chart-grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .chart-wrapper {
          height: 300px;
        }

        .chart-wrapper.tall {
          height: 400px;
        }

        .container {
          padding: 10px;
        }

        .chart-container {
          padding: 15px;
        }

        .chart-title {
          font-size: 1.1rem;
        }

        .reorder-table {
          font-size: 0.85rem;
        }

        .reorder-table th,
        .reorder-table td {
          padding: 8px;
        }
      }

      /* Tablet Optimizations */
      @media (min-width: 769px) and (max-width: 1024px) {
        .chart-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      /* Print Styles */
      @media print {
        .back-button,
        .page-footer {
          display: none;
        }

        .chart-container {
          page-break-inside: avoid;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="report-header">
        <h1>Inventory Analytics Report</h1>
        <p>Comprehensive overview of your backstock inventory with stock management</p>
        <a href="/" class="back-button">← Back to Inventory</a>
      </div>

      {% if total_items > 0 %}
        <!-- Summary Cards -->
        <div class="summary-cards">
          <div class="summary-card">
            <div class="summary-card-title">Total Items</div>
            <div class="summary-card-value">{{ total_items }}</div>
            <div class="summary-card-subtitle">Unique products</div>
          </div>

          <div class="summary-card">
            <div class="summary-card-title">Total Quantity</div>
            <div class="summary-card-value">{{ total_quantity }}</div>
            <div class="summary-card-subtitle">Units in stock</div>
          </div>

          <div class="summary-card">
            <div class="summary-card-title">Inventory Value</div>
            <div class="summary-card-value">${{ "%.2f"|format(total_value) }}</div>
            <div class="summary-card-subtitle">Total retail value</div>
          </div>

          <div class="summary-card">
            <div class="summary-card-title">Inventory Cost</div>
            <div class="summary-card-value">${{ "%.2f"|format(total_cost) }}</div>
            <div class="summary-card-subtitle">Total acquisition cost</div>
          </div>

          <div class="summary-card">
            <div class="summary-card-title">Profit Margin</div>
            <div class="summary-card-value">{{ "%.1f"|format(total_profit_margin) }}%</div>
            <div class="summary-card-subtitle">Average margin</div>
          </div>

          <div class="summary-card alert-card">
            <div class="summary-card-title">Low Stock</div>
            <div class="summary-card-value">{{ low_stock_count }}</div>
            <div class="summary-card-subtitle">Items need reorder</div>
          </div>

          <div class="summary-card danger-card">
            <div class="summary-card-title">Out of Stock</div>
            <div class="summary-card-value">{{ out_of_stock_count }}</div>
            <div class="summary-card-subtitle">Critical items</div>
          </div>

          <div class="summary-card">
            <div class="summary-card-title">Recent Sales</div>
            <div class="summary-card-value">{{ recent_sales }}</div>
            <div class="summary-card-subtitle">Last 30 days</div>
          </div>
        </div>

        <!-- Charts Grid -->
        <div class="chart-grid">
          <!-- Stock Level Health -->
          <div class="chart-container">
            <h3 class="chart-title">Stock Level Health</h3>
            <div class="chart-wrapper">
              <canvas id="stockLevelChart"></canvas>
            </div>
          </div>

          <!-- Department Distribution -->
          <div class="chart-container">
            <h3 class="chart-title">Items by Department</h3>
            <div class="chart-wrapper">
              <canvas id="deptChart"></canvas>
            </div>
          </div>

          <!-- Inventory Age Distribution -->
          <div class="chart-container">
            <h3 class="chart-title">Inventory Age Distribution</h3>
            <div class="chart-wrapper">
              <canvas id="ageChart"></canvas>
            </div>
          </div>

          <!-- Price Range Distribution -->
          <div class="chart-container">
            <h3 class="chart-title">Price Range Distribution</h3>
            <div class="chart-wrapper">
              <canvas id="priceRangeChart"></canvas>
            </div>
          </div>

          <!-- Shelf Life Distribution -->
          <div class="chart-container">
            <h3 class="chart-title">Shelf Life Distribution</h3>
            <div class="chart-wrapper">
              <canvas id="shelfLifeChart"></canvas>
            </div>
          </div>

          {% if top_value_items|length > 0 %}
          <!-- Top Items by Total Value -->
          <div class="chart-container full-width">
            <h3 class="chart-title">Top 10 Items by Total Inventory Value (Price × Quantity)</h3>
            <div class="chart-wrapper tall">
              <canvas id="topValueChart"></canvas>
            </div>
          </div>
          {% endif %}

          {% if top_items|length > 0 %}
          <!-- Top Items by Price -->
          <div class="chart-container full-width">
            <h3 class="chart-title">Top 10 Most Expensive Items (Unit Price)</h3>
            <div class="chart-wrapper tall">
              <canvas id="topItemsChart"></canvas>
            </div>
          </div>
          {% endif %}

          {% if reorder_items|length > 0 %}
          <!-- Reorder Alert Table -->
          <div class="chart-container full-width">
            <h3 class="chart-title">⚠️ Items Needing Reorder</h3>
            <table class="reorder-table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Department</th>
                  <th>Current Stock</th>
                  <th>Reorder Point</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for item in reorder_items %}
                <tr>
                  <td>{{ item.description }}</td>
                  <td>{{ item.department }}</td>
                  <td>{{ item.quantity }}</td>
                  <td>{{ item.reorder_point }}</td>
                  <td>
                    {% if item.quantity <= item.reorder_point / 2 %}
                      <span class="stock-badge critical">Critical</span>
                    {% else %}
                      <span class="stock-badge low">Low</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
        </div>

      {% else %}
        <!-- Empty State -->
        <div class="empty-state">
          <h2>No Inventory Data Available</h2>
          <p>Add items to your inventory to see analytics and reports.</p>
          <a href="/" class="back-button" style="margin-top: 20px;">← Back to Inventory</a>
        </div>
      {% endif %}
    </div>

    <!-- Footer -->
    <footer class="page-footer">
      <p>Created by: Alex Thola | Contact: <a href="mailto:alexthola@gmail.com">alexthola@gmail.com</a></p>
    </footer>

    <script>
      // Color palette
      const colors = {
        primary: '#CE2029',
        secondary: '#a31920',
        success: '#5cb85c',
        info: '#5bc0de',
        warning: '#f0ad4e',
        danger: '#d9534f',
        purple: '#9b59b6',
        orange: '#e67e22',
        teal: '#1abc9c',
        pink: '#e91e63',
        indigo: '#3f51b5'
      };

      const chartColors = [
        colors.primary,
        colors.info,
        colors.success,
        colors.warning,
        colors.purple,
        colors.orange,
        colors.teal,
        colors.pink,
        colors.indigo,
        '#34495e'
      ];

      // Chart.js global defaults
      Chart.defaults.font.family = "'Helvetica Neue', 'Helvetica', 'Arial', sans-serif";
      Chart.defaults.plugins.legend.display = true;
      Chart.defaults.plugins.legend.position = 'bottom';
      Chart.defaults.responsive = true;
      Chart.defaults.maintainAspectRatio = false;

      {% if total_items > 0 %}
      // Stock Level Health Chart (Doughnut)
      const stockLevelCtx = document.getElementById('stockLevelChart').getContext('2d');
      const stockLevelData = {{ stock_levels|tojson }};
      new Chart(stockLevelCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(stockLevelData),
          datasets: [{
            data: Object.values(stockLevelData),
            backgroundColor: [colors.danger, colors.warning, colors.success],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'right',
              labels: {
                padding: 15,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value} items (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      // Department Distribution Chart (Doughnut)
      const deptCtx = document.getElementById('deptChart').getContext('2d');
      const deptData = {{ dept_counts|tojson }};
      new Chart(deptCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(deptData),
          datasets: [{
            data: Object.values(deptData),
            backgroundColor: chartColors,
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'right',
              labels: {
                padding: 15,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value} items (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      // Inventory Age Distribution Chart (Bar)
      const ageCtx = document.getElementById('ageChart').getContext('2d');
      const ageData = {{ age_distribution|tojson }};
      new Chart(ageCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(ageData),
          datasets: [{
            label: 'Number of Items',
            data: Object.values(ageData),
            backgroundColor: colors.info,
            borderColor: colors.secondary,
            borderWidth: 1,
            borderRadius: 5
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12
            }
          }
        }
      });

      // Price Range Distribution Chart (Bar)
      const priceRangeCtx = document.getElementById('priceRangeChart').getContext('2d');
      const priceRangeData = {{ price_ranges|tojson }};
      new Chart(priceRangeCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(priceRangeData),
          datasets: [{
            label: 'Number of Items',
            data: Object.values(priceRangeData),
            backgroundColor: colors.primary,
            borderColor: colors.secondary,
            borderWidth: 1,
            borderRadius: 5
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });

      // Shelf Life Distribution Chart (Pie)
      const shelfLifeCtx = document.getElementById('shelfLifeChart').getContext('2d');
      const shelfLifeData = {{ shelf_life_counts|tojson }};
      new Chart(shelfLifeCtx, {
        type: 'pie',
        data: {
          labels: Object.keys(shelfLifeData),
          datasets: [{
            data: Object.values(shelfLifeData),
            backgroundColor: chartColors,
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'right',
              labels: {
                padding: 15,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value} items (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      {% if top_value_items|length > 0 %}
      // Top Items by Value Chart (Horizontal Bar)
      const topValueCtx = document.getElementById('topValueChart').getContext('2d');
      const topValueData = {{ top_value_items|tojson }};
      new Chart(topValueCtx, {
        type: 'bar',
        data: {
          labels: topValueData.map(item => {
            const desc = item.description;
            return desc.length > 40 ? desc.substring(0, 37) + '...' : desc;
          }),
          datasets: [{
            label: 'Total Value ($)',
            data: topValueData.map(item => item.value),
            backgroundColor: chartColors.slice(0, topValueData.length),
            borderColor: colors.secondary,
            borderWidth: 1,
            borderRadius: 5
          }]
        },
        options: {
          indexAxis: 'y',
          scales: {
            x: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value.toFixed(2);
                }
              }
            },
            y: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                title: function(context) {
                  return topValueData[context[0].dataIndex].description;
                },
                label: function(context) {
                  return 'Total Value: $' + context.parsed.x.toFixed(2);
                }
              }
            }
          }
        }
      });
      {% endif %}

      {% if top_items|length > 0 %}
      // Top Items by Price Chart (Horizontal Bar)
      const topItemsCtx = document.getElementById('topItemsChart').getContext('2d');
      const topItemsData = {{ top_items|tojson }};
      new Chart(topItemsCtx, {
        type: 'bar',
        data: {
          labels: topItemsData.map(item => {
            const desc = item.description;
            return desc.length > 40 ? desc.substring(0, 37) + '...' : desc;
          }),
          datasets: [{
            label: 'Unit Price ($)',
            data: topItemsData.map(item => item.price),
            backgroundColor: chartColors.slice(0, topItemsData.length),
            borderColor: colors.secondary,
            borderWidth: 1,
            borderRadius: 5
          }]
        },
        options: {
          indexAxis: 'y',
          scales: {
            x: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value.toFixed(2);
                }
              }
            },
            y: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                title: function(context) {
                  return topItemsData[context[0].dataIndex].description;
                },
                label: function(context) {
                  return 'Unit Price: $' + context.parsed.x.toFixed(2);
                }
              }
            }
          }
        }
      });
      {% endif %}
      {% endif %}
    </script>

    <script src="//code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  </body>
</html>
